<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin — Learnedmine Enquiries</title>
<link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,600;0,700;1,400&family=DM+Sans:wght@300;400;500;600&display=swap" rel="stylesheet">
<style>
  :root {
    --gold: #C9A84C;
    --gold2: #E8C96A;
    --dark: #080808;
    --d2: #0F0F0F;
    --d3: #161616;
    --d4: #1E1E1E;
    --text: #F0EDE8;
    --text2: #C8C3BB;
    --muted: #7A7570;
    --border: rgba(201,168,76,.12);
    --border2: rgba(255,255,255,.05);
  }
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body { background: var(--dark); color: var(--text); font-family: 'DM Sans', sans-serif; min-height: 100vh; }

  /* LOGIN SCREEN */
  #loginScreen {
    display: flex; align-items: center; justify-content: center;
    min-height: 100vh; padding: 20px;
  }
  .login-box {
    background: var(--d2); border: 1px solid var(--border);
    padding: 48px 40px; width: 100%; max-width: 420px; text-align: center;
  }
  .login-box h1 {
    font-family: 'Cormorant Garamond', serif; font-size: 2rem;
    color: var(--gold); margin-bottom: 8px;
  }
  .login-box p { color: var(--muted); font-size: .85rem; margin-bottom: 32px; }
  .login-box input {
    width: 100%; background: var(--d3); border: 1px solid var(--border2);
    color: var(--text); font-family: 'DM Sans', sans-serif; font-size: .9rem;
    padding: 14px 18px; outline: none; transition: border-color .25s; margin-bottom: 16px;
  }
  .login-box input:focus { border-color: var(--gold); }
  .login-box button {
    width: 100%; background: var(--gold); color: var(--dark); border: none;
    padding: 14px; font-family: 'DM Sans', sans-serif; font-size: .8rem;
    font-weight: 700; letter-spacing: .18em; text-transform: uppercase;
    cursor: pointer; transition: background .25s;
  }
  .login-box button:hover { background: var(--gold2); }
  #loginError {
    color: #e05252; font-size: .82rem; margin-top: 12px; display: none;
  }

  /* ADMIN DASHBOARD */
  #dashboard { display: none; padding: 0; }

  header {
    background: var(--d2); border-bottom: 1px solid var(--border);
    padding: 20px 40px; display: flex; align-items: center;
    justify-content: space-between; position: sticky; top: 0; z-index: 100;
  }
  header h1 {
    font-family: 'Cormorant Garamond', serif; font-size: 1.5rem;
    color: var(--gold); font-weight: 700;
  }
  header h1 span { color: var(--text); font-weight: 300; font-style: italic; }
  .header-right { display: flex; align-items: center; gap: 16px; }
  .badge {
    background: var(--gold-bg, rgba(201,168,76,.1)); border: 1px solid var(--border);
    color: var(--gold); font-size: .7rem; letter-spacing: .14em;
    text-transform: uppercase; padding: 6px 14px;
  }
  .btn-logout {
    background: transparent; border: 1px solid var(--border2); color: var(--muted);
    font-family: 'DM Sans', sans-serif; font-size: .72rem; letter-spacing: .14em;
    text-transform: uppercase; padding: 8px 18px; cursor: pointer; transition: all .25s;
  }
  .btn-logout:hover { border-color: var(--gold); color: var(--gold); }
  .btn-csv {
    background: var(--gold); color: var(--dark); border: none;
    font-family: 'DM Sans', sans-serif; font-size: .72rem; font-weight: 700;
    letter-spacing: .14em; text-transform: uppercase; padding: 8px 18px;
    cursor: pointer; transition: background .25s;
  }
  .btn-csv:hover { background: var(--gold2); }

  .main { padding: 40px; }

  /* STATS */
  .stats {
    display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
    gap: 1px; background: var(--border); margin-bottom: 40px;
  }
  .stat {
    background: var(--d2); padding: 24px 28px;
  }
  .stat-num {
    font-family: 'Cormorant Garamond', serif; font-size: 2.8rem;
    color: var(--gold); line-height: 1;
  }
  .stat-label {
    font-size: .68rem; letter-spacing: .18em; text-transform: uppercase;
    color: var(--muted); margin-top: 6px;
  }

  /* FILTERS */
  .filters {
    display: flex; align-items: center; gap: 12px; margin-bottom: 24px; flex-wrap: wrap;
  }
  .filter-btn {
    background: transparent; border: 1px solid var(--border2); color: var(--muted);
    font-family: 'DM Sans', sans-serif; font-size: .72rem; letter-spacing: .14em;
    text-transform: uppercase; padding: 8px 18px; cursor: pointer; transition: all .25s;
  }
  .filter-btn:hover, .filter-btn.active {
    border-color: var(--gold); color: var(--gold);
  }
  .search-input {
    background: var(--d3); border: 1px solid var(--border2); color: var(--text);
    font-family: 'DM Sans', sans-serif; font-size: .85rem; padding: 8px 16px;
    outline: none; transition: border-color .25s; margin-left: auto; width: 220px;
  }
  .search-input:focus { border-color: var(--gold); }

  /* TABLE */
  .table-wrap {
    background: var(--d2); border: 1px solid var(--border); overflow-x: auto;
  }
  table { width: 100%; border-collapse: collapse; min-width: 700px; }
  thead { background: var(--d3); }
  th {
    text-align: left; font-size: .68rem; letter-spacing: .16em;
    text-transform: uppercase; color: var(--muted); font-weight: 500;
    padding: 14px 20px; border-bottom: 1px solid var(--border);
  }
  td {
    padding: 16px 20px; font-size: .88rem; color: var(--text2);
    border-bottom: 1px solid var(--border2); vertical-align: top;
  }
  tr:last-child td { border-bottom: none; }
  tr:hover td { background: rgba(201,168,76,.03); }
  .tag {
    display: inline-block; font-size: .65rem; letter-spacing: .12em;
    text-transform: uppercase; padding: 3px 10px; font-weight: 600;
  }
  .tag-contact { background: rgba(201,168,76,.12); color: var(--gold); }
  .tag-brief { background: rgba(100,180,255,.1); color: #6ab4ff; }
  .td-name { color: var(--text); font-weight: 500; }
  .td-date { font-size: .78rem; color: var(--muted); white-space: nowrap; }
  .td-msg { max-width: 280px; color: var(--muted); font-size: .83rem; line-height: 1.5; }

  /* EMPTY/LOADING */
  .empty {
    text-align: center; padding: 80px 20px; color: var(--muted);
  }
  .empty h3 {
    font-family: 'Cormorant Garamond', serif; font-size: 1.8rem;
    color: var(--text2); margin-bottom: 8px;
  }
  .loading {
    text-align: center; padding: 80px 20px; color: var(--muted); font-size: .85rem;
    letter-spacing: .14em; text-transform: uppercase;
  }

  @media(max-width:600px) {
    header { padding: 16px 20px; }
    .main { padding: 24px 16px; }
    .header-right .badge { display: none; }
  }
</style>
</head>
<body>

<!-- LOGIN -->
<div id="loginScreen">
  <div class="login-box">
    <h1>Learned<span>mine</span></h1>
    <p>Admin — Client Enquiries</p>
    <input type="password" id="pwInput" placeholder="Enter admin password" onkeydown="if(event.key==='Enter')login()">
    <button onclick="login()">Access Dashboard</button>
    <div id="loginError">Incorrect password. Please try again.</div>
  </div>
</div>

<!-- DASHBOARD -->
<div id="dashboard">
  <header>
    <h1>Learned<span>mine</span> &nbsp;<span style="color:var(--muted);font-size:1rem;font-style:normal;font-weight:300;">/ Enquiries</span></h1>
    <div class="header-right">
      <span class="badge" id="totalBadge">0 total</span>
      <button class="btn-csv" onclick="downloadCSV()">⬇ Download CSV</button>
      <button class="btn-logout" onclick="logout()">Logout</button>
    </div>
  </header>

  <div class="main">
    <!-- STATS -->
    <div class="stats">
      <div class="stat">
        <div class="stat-num" id="statTotal">0</div>
        <div class="stat-label">Total Enquiries</div>
      </div>
      <div class="stat">
        <div class="stat-num" id="statContact">0</div>
        <div class="stat-label">Contact Form</div>
      </div>
      <div class="stat">
        <div class="stat-num" id="statBrief">0</div>
        <div class="stat-label">Project Briefs</div>
      </div>
      <div class="stat">
        <div class="stat-num" id="statToday">0</div>
        <div class="stat-label">Today</div>
      </div>
    </div>

    <!-- FILTERS -->
    <div class="filters">
      <button class="filter-btn active" onclick="setFilter('all', this)">All</button>
      <button class="filter-btn" onclick="setFilter('contact', this)">Contact</button>
      <button class="filter-btn" onclick="setFilter('brief', this)">Project Briefs</button>
      <input class="search-input" type="text" id="searchInput" placeholder="Search name or contact..." oninput="renderTable()">
    </div>

    <!-- TABLE -->
    <div class="table-wrap">
      <div class="loading" id="loadingMsg">Loading enquiries...</div>
      <table id="enquiriesTable" style="display:none;">
        <thead>
          <tr>
            <th>#</th>
            <th>Type</th>
            <th>Name</th>
            <th>Contact</th>
            <th>Service / Business</th>
            <th>Message</th>
            <th>Files</th>
            <th>Date</th>
          </tr>
        </thead>
        <tbody id="tableBody"></tbody>
      </table>
      <div class="empty" id="emptyMsg" style="display:none;">
        <h3>No enquiries yet</h3>
        <p>Submissions will appear here once clients fill out your forms.</p>
      </div>
    </div>
  </div>
</div>

<script>
  let allData = [];
  let activeFilter = 'all';
  let adminPassword = '';

  function login() {
    const pw = document.getElementById('pwInput').value.trim();
    if (!pw) return;
    adminPassword = pw;
    fetchEnquiries();
  }

  function logout() {
    adminPassword = '';
    allData = [];
    document.getElementById('dashboard').style.display = 'none';
    document.getElementById('loginScreen').style.display = 'flex';
    document.getElementById('pwInput').value = '';
    document.getElementById('loginError').style.display = 'none';
  }

  async function fetchEnquiries() {
    try {
      const res = await fetch('/.netlify/functions/get-enquiries?password=' + encodeURIComponent(adminPassword));

      if (res.status === 401) {
        document.getElementById('loginError').style.display = 'block';
        adminPassword = '';
        return;
      }

      const data = await res.json();
      if (data.error) throw new Error(data.error);

      allData = data;
      document.getElementById('loginError').style.display = 'none';
      document.getElementById('loginScreen').style.display = 'none';
      document.getElementById('dashboard').style.display = 'block';
      document.getElementById('loadingMsg').style.display = 'none';
      updateStats();
      renderTable();

    } catch (err) {
      document.getElementById('loginError').textContent = 'Could not connect. Check your setup.';
      document.getElementById('loginError').style.display = 'block';
    }
  }

  function updateStats() {
    const today = new Date().toDateString();
    document.getElementById('statTotal').textContent = allData.length;
    document.getElementById('statContact').textContent = allData.filter(r => r.form_type === 'contact').length;
    document.getElementById('statBrief').textContent = allData.filter(r => r.form_type === 'brief').length;
    document.getElementById('statToday').textContent = allData.filter(r => new Date(r.submitted_at).toDateString() === today).length;
    document.getElementById('totalBadge').textContent = allData.length + ' total';
  }

  function setFilter(f, btn) {
    activeFilter = f;
    document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    renderTable();
  }

  function renderTable() {
    const search = document.getElementById('searchInput').value.toLowerCase();
    let rows = allData.filter(r => {
      const matchFilter = activeFilter === 'all' || r.form_type === activeFilter;
      const matchSearch = !search ||
        (r.name || '').toLowerCase().includes(search) ||
        (r.contact || '').toLowerCase().includes(search) ||
        (r.message || '').toLowerCase().includes(search);
      return matchFilter && matchSearch;
    });

    const tbody = document.getElementById('tableBody');
    const table = document.getElementById('enquiriesTable');
    const empty = document.getElementById('emptyMsg');

    if (rows.length === 0) {
      table.style.display = 'none';
      empty.style.display = 'block';
      return;
    }

    table.style.display = 'table';
    empty.style.display = 'none';

    tbody.innerHTML = rows.map((r, i) => `
      <tr>
        <td style="color:var(--muted);font-size:.78rem;">${allData.length - allData.indexOf(r)}</td>
        <td><span class="tag tag-${r.form_type}">${r.form_type}</span></td>
        <td class="td-name">${esc(r.name)}</td>
        <td>${esc(r.contact)}</td>
        <td style="color:var(--muted);font-size:.83rem;">${esc(r.service || r.business || '—')}</td>
        <td class="td-msg">${esc(r.message || '—')}</td>
        <td style="min-width:160px">${renderFiles(r.file_urls)}</td>
        <td class="td-date">${formatDate(r.submitted_at)}</td>
      </tr>
    `).join('');
  }

  function formatDate(dt) {
    if (!dt) return '—';
    const d = new Date(dt);
    return d.toLocaleDateString('en-GB', { day:'2-digit', month:'short', year:'numeric' }) +
           '<br><span style="font-size:.72rem;color:var(--muted)">' +
           d.toLocaleTimeString('en-GB', { hour:'2-digit', minute:'2-digit' }) + '</span>';
  }

  function esc(str) {
    if (!str) return '—';
    return String(str).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
  }


  function renderFiles(file_urls) {
    if (!file_urls) return '<span style="color:var(--muted);font-size:.78rem;">—</span>';
    const urls = file_urls.split(',').map(u => u.trim()).filter(Boolean);
    if (!urls.length) return '<span style="color:var(--muted);font-size:.78rem;">—</span>';
    return urls.map((url, i) => {
      const ext = url.split('.').pop().split('?')[0].toUpperCase().slice(0,4);
      return `<a href="${url}" target="_blank" style="display:inline-block;background:rgba(201,168,76,.12);color:var(--gold);border:1px solid rgba(201,168,76,.3);font-size:.65rem;letter-spacing:.1em;text-transform:uppercase;padding:4px 10px;margin:2px 2px 2px 0;text-decoration:none;transition:all .2s;" onmouseover="this.style.background='rgba(201,168,76,.25)'" onmouseout="this.style.background='rgba(201,168,76,.12)'">${ext || 'FILE'} ${i+1}</a>`;
    }).join('');
  }

  function downloadCSV() {
    if (!allData.length) return;
    const headers = ['ID','Type','Name','Contact','Service/Business','Message','Files','Date'];
    const rows = allData.map(r => [
      r.id, r.form_type, r.name, r.contact,
      r.service || r.business || '',
      (r.message || '').replace(/,/g, ';'),
      (r.file_urls || '').replace(/,/g, ' | '),
      new Date(r.submitted_at).toLocaleString('en-GB')
    ]);
    const csv = [headers, ...rows].map(r => r.map(c => `"${c}"`).join(',')).join('\n');
    const blob = new Blob([csv], { type: 'text/csv' });
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'learnedmine-enquiries-' + new Date().toISOString().slice(0,10) + '.csv';
    a.click();
  }
</script>
</body>
</html>
